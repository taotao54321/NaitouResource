+++
title = "駒の損得評価"
date = 2022-01-21
+++

局面評価は主に駒の損得に基づいて行われる。  

駒の損得は、盤面の各マスについて駒得/駒損が発生するかどうかを調べることで評価される。  
駒得が発生するマスを「駒得マス」、駒損が発生するマスを「駒損マス」と呼ぶ(COM側の立場で命名している)。

全ての駒得マスの上にあるプレイヤー駒について、その価値の最大値を「最大駒得価値」、価値の総和を「総駒得価値」と呼ぶ。  
最大駒得価値を持つ駒得マス(複数ある場合はマスの値が最小のもの)を「最大駒得マス」と呼ぶ。

全ての駒損マスの上にあるCOM駒について、その価値の最大値を「最大駒損価値」、価値の総和を「総駒損価値」と呼ぶ。  
最大駒損価値を持つ駒損マス(複数ある場合はマスの値が最小のもの)を「最大駒損マス」と呼ぶ。

## 駒得マス {#advantage}

プレイヤー駒のあるマスのうち、以下のいずれかの条件を満たすものが駒得マスとなる:

* COM利きがあり、プレイヤー利きがない
* 両者の利きがあり、`(COM attacker の価値) < (プレイヤー駒の価値)` である
* 両者の利きがあり、`(COM attacker の価値) == (プレイヤー駒の価値)` で、かつ進行度が 0 でない

ここで、駒価値の算定には [駒価値テーブルB](@/price-table/index.md#table-b) が使われる。

なお、進行度が 0 の場合、プレイヤー駒が玉であっても、COM attacker も玉ならばそのマスは駒得マスとみなされない。これは [玉で王手できるバグ](@/bug/index.md#check-with-king) の原因となっている。

## 駒損マス {#disadvantage}

COM駒のあるマスのうち、以下のいずれかの条件を満たすものが駒損マスとなる:

* プレイヤー利きがあり、COM駒が玉である(王手)
* プレイヤー利きがあり、COM利きがない
* 両者の利きがあり、`(COM利き数) < (プレイヤー利き数)` かつ `(COM駒の価値) + (COM attacker の価値) >= (プレイヤー attacker の価値)` である
* 両者の利きがあり、`(COM利き数) >= (プレイヤー利き数)` かつ `(COM駒の価値) > (プレイヤー attacker の価値)` である

ここで、駒価値の算定には [駒価値テーブルC](@/price-table/index.md#table-c) および [駒価値テーブルD](@/price-table/index.md#table-d) が使われる。

また、最後の条件を満たして駒損マス判定された場合、「取り返しフラグ」が立つ。これは「利きが同数以上なので取り返しが利く」といった意味。  
いったん取り返しフラグが立つと、そのマスを含め、駒損マスが現れるたびに最大駒損価値および総駒損価値が 1 減らされる。これを「取り返しフラグ補正」と呼ぶ。  
取り返しフラグ補正は王手をかけられている場合も発生する。これは [投了バグ](@/bug/index.md#resign), [COM玉が取れるバグ](@/bug/index.md#capture-com-king), [COMが王手放置して詰ましてくるバグ](@/bug/index.md#com-suicide-mate) の原因となっている。
